-- ============================================================================
-- DMS Full Metadata Install Script (Oracle)
-- Date: 2026-02-24
-- Purpose: Fresh install of metadata objects required by the application.
-- ============================================================================

CREATE TABLE users (
    user_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(255) UNIQUE NOT NULL,
    email VARCHAR2(255) UNIQUE NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    salt VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 0,
    account_status VARCHAR2(50) DEFAULT 'PENDING',
    created_by NUMBER,
    approved_by NUMBER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    password_reset_token VARCHAR2(255),
    password_reset_expires TIMESTAMP,
    failed_login_attempts NUMBER DEFAULT 0,
    FOREIGN KEY (created_by) REFERENCES users(user_id),
    FOREIGN KEY (approved_by) REFERENCES users(user_id)
);
CREATE INDEX idx_users_username ON users(username);

CREATE TABLE user_profiles (
    profile_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER UNIQUE NOT NULL,
    first_name VARCHAR2(100) NOT NULL,
    last_name VARCHAR2(100) NOT NULL,
    phone_number VARCHAR2(20),
    department VARCHAR2(100),
    position VARCHAR2(100),
    profile_image_path VARCHAR2(500),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE roles (
    role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_name VARCHAR2(100) UNIQUE NOT NULL,
    description VARCHAR2(500),
    is_system_role NUMBER(1) DEFAULT 0
);

CREATE TABLE user_roles (
    user_role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    role_id NUMBER NOT NULL,
    assigned_by NUMBER NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_user_role UNIQUE (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (role_id) REFERENCES roles(role_id),
    FOREIGN KEY (assigned_by) REFERENCES users(user_id)
);

CREATE TABLE permission_matrix (
    permission_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id NUMBER NOT NULL,
    module_name VARCHAR2(100) NOT NULL,
    can_view NUMBER(1) DEFAULT 0,
    can_create NUMBER(1) DEFAULT 0,
    can_edit NUMBER(1) DEFAULT 0,
    can_delete NUMBER(1) DEFAULT 0,
    CONSTRAINT uq_role_module UNIQUE (role_id, module_name),
    FOREIGN KEY (role_id) REFERENCES roles(role_id)
);

CREATE TABLE password_history (
    history_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE login_audit_log (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER,
    target_user_id NUMBER,
    login_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR2(45) NOT NULL,
    login_status VARCHAR2(20) NOT NULL,
    login_type VARCHAR2(20) NOT NULL,
    details CLOB,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (target_user_id) REFERENCES users(user_id)
);

CREATE TABLE modules (
    module_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    module_name VARCHAR2(100) UNIQUE NOT NULL,
    display_name VARCHAR2(200) NOT NULL,
    description VARCHAR2(1000),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_module_access (
    access_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    module_key VARCHAR2(100) NOT NULL,
    is_enabled NUMBER(1) DEFAULT 1 NOT NULL,
    assigned_by NUMBER,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_user_module_access UNIQUE (user_id, module_key),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (assigned_by) REFERENCES users(user_id)
);
CREATE INDEX idx_user_module_access_user ON user_module_access(user_id);

CREATE TABLE audit_logs (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER,
    action VARCHAR2(100) NOT NULL,
    resource_type VARCHAR2(100),
    resource_id VARCHAR2(100),
    ip_address VARCHAR2(45),
    user_agent VARCHAR2(1000),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);

INSERT INTO modules (module_name, display_name, description)
SELECT 'dashboard', 'Dashboard', 'Main dashboard features' FROM dual
WHERE NOT EXISTS (SELECT 1 FROM modules WHERE module_name = 'dashboard');

INSERT INTO modules (module_name, display_name, description)
SELECT 'users', 'Users Management', 'User management features' FROM dual
WHERE NOT EXISTS (SELECT 1 FROM modules WHERE module_name = 'users');

INSERT INTO modules (module_name, display_name, description)
SELECT 'reports', 'Reports', 'Reporting features' FROM dual
WHERE NOT EXISTS (SELECT 1 FROM modules WHERE module_name = 'reports');

INSERT INTO modules (module_name, display_name, description)
SELECT 'analytics', 'Analytics', 'Analytics features' FROM dual
WHERE NOT EXISTS (SELECT 1 FROM modules WHERE module_name = 'analytics');

INSERT INTO modules (module_name, display_name, description)
SELECT 'settings', 'Settings', 'System settings' FROM dual
WHERE NOT EXISTS (SELECT 1 FROM modules WHERE module_name = 'settings');

CREATE TABLE DMS_DBCONDTLS (
    CONID NUMBER PRIMARY KEY,
    CONNM VARCHAR2(100),
    DBHOST VARCHAR2(100),
    DBPORT NUMBER,
    DBSRVNM VARCHAR2(100),
    USRNM VARCHAR2(100),
    PASSWD VARCHAR2(400),
    CONSTR VARCHAR2(1000),
    SCHNM VARCHAR2(128) NOT NULL,
    CURFLG CHAR(1) DEFAULT 'Y'
);

CREATE TABLE DMS_PARAMS (
    PRTYP VARCHAR2(100) NOT NULL,
    PRCD VARCHAR2(100) NOT NULL,
    PRDESC VARCHAR2(500),
    PRVAL VARCHAR2(4000),
    DBTYP VARCHAR2(50) DEFAULT 'GENERIC',
    PRRECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    PRRECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);
ALTER TABLE DMS_PARAMS ADD CONSTRAINT UK_DMS_PARAMS_TYPE_DB_CODE UNIQUE (PRTYP, DBTYP, PRCD);
CREATE INDEX IDX_DMS_PARAMS_DATATYPE_DB ON DMS_PARAMS(PRTYP, DBTYP, PRCD);

CREATE TABLE DMS_SUPPORTED_DATABASES (
    DBID NUMBER PRIMARY KEY,
    DBTYP VARCHAR2(50) UNIQUE NOT NULL,
    DBDESC VARCHAR2(200),
    DBVRSN VARCHAR2(50),
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE',
    CRTDBY VARCHAR2(100),
    CRTDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDTDBY VARCHAR2(100),
    UPDTDT TIMESTAMP
);
CREATE INDEX IDX_DMS_SUPPORTED_DB_STATUS ON DMS_SUPPORTED_DATABASES(STATUS, DBTYP);

CREATE TABLE DMS_MAPRSQL (
    MAPRSQLID NUMBER PRIMARY KEY,
    MAPRSQLCD VARCHAR2(100) NOT NULL,
    MAPRSQL CLOB,
    SQLCONID NUMBER,
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y',
    CONSTRAINT FK_DMS_MAPRSQL_SQLCONID FOREIGN KEY (SQLCONID) REFERENCES DMS_DBCONDTLS(CONID)
);
CREATE INDEX IDX_DMS_MAPRSQL_CD_CUR ON DMS_MAPRSQL(MAPRSQLCD, CURFLG);

CREATE TABLE DMS_MAPR (
    MAPID NUMBER PRIMARY KEY,
    MAPREF VARCHAR2(50) UNIQUE NOT NULL,
    MAPDESC VARCHAR2(500),
    TRGSCHM VARCHAR2(100),
    TRGTBTYP VARCHAR2(20),
    TRGTBNM VARCHAR2(100),
    FRQCD VARCHAR2(10),
    SRCSYSTM VARCHAR2(100),
    LGVRFYFLG CHAR(1) DEFAULT 'N',
    LGVRFYDT TIMESTAMP,
    STFLG CHAR(1) DEFAULT 'N',
    BLKPRCROWS NUMBER,
    TRGCONID NUMBER,
    CHKPNTSTRTGY VARCHAR2(20) DEFAULT 'AUTO',
    CHKPNTCLNM VARCHAR2(100),
    CHKPNTENBLD CHAR(1) DEFAULT 'Y',
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    UPTDBY VARCHAR2(100),
    CONSTRAINT FK_DMS_MAPR_TRGCONID FOREIGN KEY (TRGCONID) REFERENCES DMS_DBCONDTLS(CONID)
);
CREATE INDEX IDX_DMS_MAPR_REF_CUR ON DMS_MAPR(MAPREF, CURFLG);

CREATE TABLE DMS_MAPRDTL (
    MAPDTLID NUMBER PRIMARY KEY,
    MAPREF VARCHAR2(50) NOT NULL,
    TRGCLNM VARCHAR2(100) NOT NULL,
    TRGCLDTYP VARCHAR2(50),
    TRGKEYFLG CHAR(1),
    TRGKEYSEQ NUMBER,
    TRGCLDESC VARCHAR2(500),
    MAPLOGIC CLOB,
    MAPRSQLCD VARCHAR2(100),
    KEYCLNM VARCHAR2(100),
    VALCLNM VARCHAR2(100),
    MAPCMBCD VARCHAR2(20),
    EXCSEQ NUMBER,
    SCDTYP NUMBER,
    LGVRFYFLG CHAR(1),
    LGVRFYDT TIMESTAMP,
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    UPTDBY VARCHAR2(100),
    CONSTRAINT FK_DMS_MAPRDTL_MAPREF FOREIGN KEY (MAPREF) REFERENCES DMS_MAPR(MAPREF)
);
CREATE INDEX IDX_DMS_MAPRDTL_REF_CUR ON DMS_MAPRDTL(MAPREF, CURFLG);

CREATE TABLE DMS_MAPERR (
    MAPERRID NUMBER PRIMARY KEY,
    MAPDTLID NUMBER,
    MAPREF VARCHAR2(50),
    MAPLOGIC CLOB,
    ERRTYP VARCHAR2(20),
    ERRMSG CLOB,
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE DMS_JOB (
    JOBID NUMBER PRIMARY KEY,
    MAPID NUMBER,
    MAPREF VARCHAR2(50) NOT NULL,
    FRQCD VARCHAR2(10),
    TRGSCHM VARCHAR2(100),
    TRGTBTYP VARCHAR2(20),
    TRGTBNM VARCHAR2(100),
    SRCSYSTM VARCHAR2(100),
    STFLG CHAR(1),
    BLKPRCROWS NUMBER,
    TRGCONID NUMBER,
    CHKPNTSTRTGY VARCHAR2(20),
    CHKPNTCLNM VARCHAR2(100),
    CHKPNTENBLD CHAR(1),
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);

CREATE TABLE DMS_JOBDTL (
    JOBDTLID NUMBER PRIMARY KEY,
    MAPREF VARCHAR2(50) NOT NULL,
    MAPDTLID NUMBER,
    TRGCLNM VARCHAR2(100),
    TRGCLDTYP VARCHAR2(50),
    TRGKEYFLG CHAR(1),
    TRGKEYSEQ NUMBER,
    TRGCLDESC VARCHAR2(500),
    MAPLOGIC CLOB,
    MAPRSQLCD VARCHAR2(100),
    KEYCLNM VARCHAR2(100),
    VALCLNM VARCHAR2(100),
    MAPCMBCD VARCHAR2(20),
    EXCSEQ NUMBER,
    SCDTYP NUMBER,
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);

CREATE TABLE DMS_JOBFLW (
    JOBFLWID NUMBER PRIMARY KEY,
    JOBID NUMBER,
    MAPREF VARCHAR2(50),
    TRGSCHM VARCHAR2(100),
    TRGTBTYP VARCHAR2(20),
    TRGTBNM VARCHAR2(100),
    DWLOGIC CLOB,
    STFLG CHAR(1) DEFAULT 'A',
    RECRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);

CREATE TABLE DMS_JOBSCH (
    JOBSCHID NUMBER PRIMARY KEY,
    JOBID NUMBER NOT NULL,
    MAPREF VARCHAR2(50) NOT NULL,
    FRQCD VARCHAR2(10),
    FRQDD VARCHAR2(10),
    FRQHH NUMBER,
    FRQMI NUMBER,
    ENABLEFLG CHAR(1) DEFAULT 'Y',
    DPND_JOBSCHID NUMBER,
    STRDT TIMESTAMP,
    ENDDT TIMESTAMP,
    LST_RUN_DT TIMESTAMP,
    NXT_RUN_DT TIMESTAMP,
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y',
    CONSTRAINT FK_DMS_JOBSCH_JOB FOREIGN KEY (JOBID) REFERENCES DMS_JOB(JOBID)
);

CREATE TABLE DMS_PRCLOG (
    PRCID NUMBER PRIMARY KEY,
    JOBID NUMBER,
    JOBFLWID NUMBER,
    STRTDT TIMESTAMP,
    ENDDT TIMESTAMP,
    STATUS VARCHAR2(10),
    MSG CLOB,
    PRCLOG CLOB,
    MAPREF VARCHAR2(100),
    SESSIONID NUMBER(30),
    PARAM1 VARCHAR2(4000), PARAM2 VARCHAR2(4000), PARAM3 VARCHAR2(4000), PARAM4 VARCHAR2(4000), PARAM5 VARCHAR2(4000),
    PARAM6 VARCHAR2(4000), PARAM7 VARCHAR2(4000), PARAM8 VARCHAR2(4000), PARAM9 VARCHAR2(4000), PARAM10 VARCHAR2(4000),
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    RECUPDT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE DMS_JOBLOG (
    JOBLOGID NUMBER PRIMARY KEY,
    PRCDT TIMESTAMP,
    MAPREF VARCHAR2(100),
    JOBID NUMBER,
    SRCROWS NUMBER,
    TRGROWS NUMBER,
    ERRROWS NUMBER,
    PRCID NUMBER,
    SESSIONID NUMBER(30),
    RECCRDT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE DMS_JOBERR (
    JOBLOGID NUMBER,
    ERRID NUMBER,
    PRCDT TIMESTAMP,
    ERRTYP VARCHAR2(10),
    DBERRMSG CLOB,
    ERRMSG CLOB,
    KEYVALUE VARCHAR2(1000),
    JOBID NUMBER,
    SESSIONID NUMBER(30),
    PRCID NUMBER,
    MAPREF VARCHAR2(100)
);

CREATE TABLE DMS_PRCREQ (
    REQUEST_ID VARCHAR2(64) NOT NULL,
    MAPREF VARCHAR2(100) NOT NULL,
    REQUEST_TYPE VARCHAR2(30) NOT NULL,
    PAYLOAD CLOB,
    STATUS VARCHAR2(20) DEFAULT 'NEW',
    REQUESTED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CLAIMED_AT TIMESTAMP,
    CLAIMED_BY VARCHAR2(64),
    COMPLETED_AT TIMESTAMP,
    RESULT_PAYLOAD CLOB,
    CONSTRAINT PK_DMS_PRCREQ PRIMARY KEY (REQUEST_ID)
);
CREATE INDEX DMS_PRCREQ_STATUS_IDX ON DMS_PRCREQ (STATUS, REQUESTED_AT);
CREATE INDEX DMS_PRCREQ_MAPREF_IDX ON DMS_PRCREQ (MAPREF);

CREATE TABLE DMS_IDPOOL (
    ENTITY_NAME VARCHAR2(64) PRIMARY KEY,
    CURRENT_VALUE NUMBER(20) NOT NULL,
    BLOCK_SIZE NUMBER(10) DEFAULT 500,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);
CREATE INDEX IDX_DMS_IDPOOL_UPDATED ON DMS_IDPOOL(UPDATED_AT);

CREATE TABLE DMS_FLUPLD (
    FLUPLDID NUMBER PRIMARY KEY,
    FLUPLDREF VARCHAR2(100) UNIQUE NOT NULL,
    FLUPLDDESC VARCHAR2(500),
    FLNM VARCHAR2(255),
    FLPTH VARCHAR2(2000),
    FLTYP VARCHAR2(50),
    TRGCONID NUMBER,
    TRGSCHM VARCHAR2(100),
    TRGTBLNM VARCHAR2(100),
    TRNCTFLG CHAR(1) DEFAULT 'N',
    HDRRWCNT NUMBER DEFAULT 0,
    FTRRWCNT NUMBER DEFAULT 0,
    HDRRWPTTRN VARCHAR2(500),
    FTRRWPTTRN VARCHAR2(500),
    FRQCD VARCHAR2(10),
    STFLG CHAR(1) DEFAULT 'N',
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    CRTDATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDATE TIMESTAMP,
    LSTRUNDT TIMESTAMP,
    NXTRUNDT TIMESTAMP,
    BATCH_SIZE NUMBER DEFAULT 1000,
    FLHASH VARCHAR2(64), FLSZ NUMBER, FLMIMTYP VARCHAR2(100),
    FLVRFYFLG CHAR(1) DEFAULT 'N', FLVRFYDT TIMESTAMP, FLVRFYBY VARCHAR2(100),
    FLQRNFLG CHAR(1) DEFAULT 'N', FLQRNRSN VARCHAR2(500),
    FLSCNFLG CHAR(1) DEFAULT 'N', FLSCNDT TIMESTAMP, FLSCNRSLT VARCHAR2(50),
    FLACCLVL VARCHAR2(20) DEFAULT 'PRIVATE',
    FLENCFLG CHAR(1) DEFAULT 'N', FLENCALG VARCHAR2(50),
    FLUPLDCNT NUMBER DEFAULT 0, FLLSTACCTM TIMESTAMP, FLACCCNT NUMBER DEFAULT 0,
    FLRTRNTM TIMESTAMP, FLRTRNPLCY VARCHAR2(50)
);
CREATE INDEX IDX_FLUPLD_REF ON DMS_FLUPLD(FLUPLDREF);
CREATE INDEX IDX_FLUPLD_TRGCONID ON DMS_FLUPLD(TRGCONID);
CREATE INDEX IDX_FLUPLD_CURFLG ON DMS_FLUPLD(CURFLG);

CREATE TABLE DMS_FLUPLDDTL (
    FLUPLDDTLID NUMBER PRIMARY KEY,
    FLUPLDREF VARCHAR2(100) NOT NULL,
    SRCCLNM VARCHAR2(100),
    TRGCLNM VARCHAR2(100) NOT NULL,
    TRGCLDTYP VARCHAR2(50),
    TRGKYFLG CHAR(1) DEFAULT 'N',
    TRGKYSEQ NUMBER,
    TRGCLDESC VARCHAR2(500),
    DRVLGC CLOB,
    DRVLGCFLG CHAR(1) DEFAULT 'N',
    EXCSEQ NUMBER,
    ISAUDIT CHAR(1) DEFAULT 'N',
    AUDTTYP VARCHAR2(20),
    DFLTVAL VARCHAR2(500),
    ISRQRD CHAR(1) DEFAULT 'N',
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    CRTDATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDATE TIMESTAMP
);
CREATE INDEX IDX_FLUPLDDTL_REF ON DMS_FLUPLDDTL(FLUPLDREF);
CREATE INDEX IDX_FLUPLDDTL_CURFLG ON DMS_FLUPLDDTL(CURFLG);

CREATE TABLE DMS_FLUPLDACCLG (
    ACCLGID NUMBER PRIMARY KEY,
    FLUPLDREF VARCHAR2(100) NOT NULL,
    USRID NUMBER,
    USRNM VARCHAR2(100),
    ACCTYP VARCHAR2(20),
    ACCDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    IPADDR VARCHAR2(45),
    USRAGNT VARCHAR2(500),
    ACCSTS VARCHAR2(20),
    ACCRSN VARCHAR2(500),
    FLSZ NUMBER,
    FLHASH VARCHAR2(64)
);
CREATE INDEX IDX_FLUPLDACCLG_REF ON DMS_FLUPLDACCLG(FLUPLDREF);
CREATE INDEX IDX_FLUPLDACCLG_USRID ON DMS_FLUPLDACCLG(USRID);
CREATE INDEX IDX_FLUPLDACCLG_ACCDT ON DMS_FLUPLDACCLG(ACCDT);
CREATE INDEX IDX_FLUPLDACCLG_ACCTYP ON DMS_FLUPLDACCLG(ACCTYP);

CREATE TABLE DMS_FLUPLDVLD (
    VLDID NUMBER PRIMARY KEY,
    FLTYP VARCHAR2(50) NOT NULL,
    MAXSZ NUMBER,
    ALWDEXNS CLOB,
    ALWDMIMTYPS CLOB,
    BLCDEXNS CLOB,
    BLCDPTTRNS CLOB,
    RQRVRFY CHAR(1) DEFAULT 'Y',
    RQRSCN CHAR(1) DEFAULT 'Y',
    RQRENC CHAR(1) DEFAULT 'N',
    MAXCLMCNT NUMBER,
    MAXRWCNT NUMBER,
    VLDCNTNT CHAR(1) DEFAULT 'Y',
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    CRTDATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDATE TIMESTAMP
);
CREATE INDEX IDX_FLUPLDVLD_FLTYP ON DMS_FLUPLDVLD(FLTYP);

CREATE TABLE DMS_FLUPLDSEC (
    SECID NUMBER PRIMARY KEY,
    SCNNGNBL CHAR(1) DEFAULT 'Y',
    SCNNGPRVD VARCHAR2(50),
    SCNNGCMD VARCHAR2(500),
    RQRVRFY CHAR(1) DEFAULT 'Y',
    RQRENC CHAR(1) DEFAULT 'N',
    ENCALG VARCHAR2(50),
    QRNTNFLG CHAR(1) DEFAULT 'Y',
    QRNTNDIR VARCHAR2(1000),
    RTRNTM NUMBER DEFAULT 90,
    MAXFLSZ NUMBER DEFAULT 104857600,
    MAXUPLDHR NUMBER DEFAULT 50,
    MAXSZHR NUMBER DEFAULT 524288000,
    ALWDFLEXTS CLOB,
    BLCDFLEXTS CLOB,
    ALWDIPRNGS CLOB,
    BLCDIPRNGS CLOB,
    CURFLG CHAR(1) DEFAULT 'Y',
    CRTDBY VARCHAR2(100),
    CRTDATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDATE TIMESTAMP
);

CREATE TABLE DMS_FLUPLD_SCHD (
    SCHDID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    FLUPLDREF VARCHAR2(50) NOT NULL,
    FRQNCY VARCHAR2(10) NOT NULL,
    TM_PRM VARCHAR2(100),
    NXT_RUN_DT TIMESTAMP,
    LST_RUN_DT TIMESTAMP,
    STTS VARCHAR2(20) NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDT TIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);
CREATE INDEX IDX_FLUPLD_SCHD_FLUPLDREF ON DMS_FLUPLD_SCHD(FLUPLDREF);
CREATE INDEX IDX_FLUPLD_SCHD_FRQNCY ON DMS_FLUPLD_SCHD(FRQNCY);
CREATE INDEX IDX_FLUPLD_SCHD_NXTRUN ON DMS_FLUPLD_SCHD(NXT_RUN_DT);

CREATE TABLE DMS_FLUPLD_RUN (
    RUNID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    FLUPLDREF VARCHAR2(50) NOT NULL,
    STRTTM TIMESTAMP NOT NULL,
    NDTM TIMESTAMP,
    RWSPRCSSD NUMBER DEFAULT 0,
    RWSSTCCSSFL NUMBER DEFAULT 0,
    RWSFLD NUMBER DEFAULT 0,
    STTS VARCHAR2(20) NOT NULL,
    MSSG CLOB,
    LDMDE VARCHAR2(20),
    FLPTH VARCHAR2(4000),
    CRTDBY VARCHAR2(100),
    CRTDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPTDBY VARCHAR2(100),
    UPTDT TIMESTAMP,
    CURFLG CHAR(1) DEFAULT 'Y'
);
CREATE INDEX IDX_FLUPLD_RUN_FLUPLDREF ON DMS_FLUPLD_RUN(FLUPLDREF);
CREATE INDEX IDX_FLUPLD_RUN_START_TIME ON DMS_FLUPLD_RUN(STRTTM DESC);

CREATE TABLE DMS_FLUPLD_ERR (
    ERRID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    FLUPLDREF VARCHAR2(50) NOT NULL,
    RUNID NUMBER NOT NULL,
    RWNDX NUMBER NOT NULL,
    RWDTJSN CLOB,
    RRCD VARCHAR2(50),
    RRMSSG CLOB NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDT TIMESTAMP DEFAULT SYSTIMESTAMP
);
CREATE INDEX IDX_FLUPLD_ERR_FLUPLDREF ON DMS_FLUPLD_ERR(FLUPLDREF);
CREATE INDEX IDX_FLUPLD_ERR_RUNID ON DMS_FLUPLD_ERR(RUNID);
CREATE INDEX IDX_FLUPLD_ERR_RRCD ON DMS_FLUPLD_ERR(RRCD);

CREATE TABLE DMS_DASH_DEF (
    DASHID NUMBER PRIMARY KEY,
    DASHNM VARCHAR2(200) NOT NULL,
    DSCRPTN VARCHAR2(1000),
    OWNER_USRID NUMBER,
    IS_ACTV CHAR(1) DEFAULT 'Y' NOT NULL,
    CURFLG CHAR(1) DEFAULT 'Y' NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDTDBY VARCHAR2(100),
    UPDTDT TIMESTAMP
);
CREATE UNIQUE INDEX UK_DMS_DASH_DEF_NM_OWNER ON DMS_DASH_DEF(DASHNM, OWNER_USRID, CURFLG);
CREATE INDEX IDX_DMS_DASH_DEF_OWNER ON DMS_DASH_DEF(OWNER_USRID, IS_ACTV, CURFLG);

CREATE TABLE DMS_DASH_WIDGET (
    WIDGTID NUMBER PRIMARY KEY,
    DASHID NUMBER NOT NULL,
    WIDGTNM VARCHAR2(200) NOT NULL,
    WIDGTTYP VARCHAR2(30) NOT NULL,
    SRCMODE VARCHAR2(20) NOT NULL,
    SQLSRCID NUMBER,
    ADHCSQL CLOB,
    DBCNID NUMBER,
    CFG_JSON CLOB,
    LAYOUT_JSON CLOB,
    ORDER_NO NUMBER DEFAULT 1,
    IS_ACTV CHAR(1) DEFAULT 'Y' NOT NULL,
    CURFLG CHAR(1) DEFAULT 'Y' NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDTDBY VARCHAR2(100),
    UPDTDT TIMESTAMP,
    CONSTRAINT FK_DASH_WIDGET_DEF FOREIGN KEY (DASHID) REFERENCES DMS_DASH_DEF(DASHID)
);
CREATE INDEX IDX_DMS_DASH_WIDGET_DASH ON DMS_DASH_WIDGET(DASHID, IS_ACTV, CURFLG, ORDER_NO);

CREATE TABLE DMS_DASH_FILTER (
    FLTRID NUMBER PRIMARY KEY,
    DASHID NUMBER NOT NULL,
    SCOPE_TYP VARCHAR2(20) NOT NULL,
    WIDGTID NUMBER,
    FLTR_KEY VARCHAR2(100) NOT NULL,
    FLTR_TYP VARCHAR2(30) NOT NULL,
    FLTR_CFG_JSON CLOB,
    IS_ACTV CHAR(1) DEFAULT 'Y' NOT NULL,
    CURFLG CHAR(1) DEFAULT 'Y' NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDTDBY VARCHAR2(100),
    UPDTDT TIMESTAMP,
    CONSTRAINT FK_DASH_FILTER_DEF FOREIGN KEY (DASHID) REFERENCES DMS_DASH_DEF(DASHID),
    CONSTRAINT FK_DASH_FILTER_WIDGET FOREIGN KEY (WIDGTID) REFERENCES DMS_DASH_WIDGET(WIDGTID)
);
CREATE INDEX IDX_DMS_DASH_FILTER_DASH ON DMS_DASH_FILTER(DASHID, IS_ACTV, CURFLG);

CREATE TABLE DMS_DASH_SHARE (
    SHAREID NUMBER PRIMARY KEY,
    DASHID NUMBER NOT NULL,
    SHARE_TYP VARCHAR2(20) NOT NULL,
    SHARE_REF_ID NUMBER NOT NULL,
    CAN_VIEW CHAR(1) DEFAULT 'Y' NOT NULL,
    CAN_EDIT CHAR(1) DEFAULT 'N' NOT NULL,
    CAN_EXPORT CHAR(1) DEFAULT 'Y' NOT NULL,
    IS_ACTV CHAR(1) DEFAULT 'Y' NOT NULL,
    CURFLG CHAR(1) DEFAULT 'Y' NOT NULL,
    CRTDBY VARCHAR2(100),
    CRTDDT TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDTDBY VARCHAR2(100),
    UPDTDT TIMESTAMP,
    CONSTRAINT FK_DASH_SHARE_DEF FOREIGN KEY (DASHID) REFERENCES DMS_DASH_DEF(DASHID)
);
CREATE UNIQUE INDEX UK_DMS_DASH_SHARE_UK ON DMS_DASH_SHARE(DASHID, SHARE_TYP, SHARE_REF_ID, CURFLG);

CREATE TABLE DMS_DASH_EXPORT_LOG (
    EXPID NUMBER PRIMARY KEY,
    DASHID NUMBER NOT NULL,
    EXPRT_FMT VARCHAR2(10) NOT NULL,
    EXPRT_BY VARCHAR2(100),
    EXPRT_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    STTS VARCHAR2(20) DEFAULT 'SUCCESS',
    MSG VARCHAR2(2000),
    FILE_NM VARCHAR2(500),
    FILE_SZ_BYTES NUMBER,
    CONSTRAINT FK_DASH_EXPORT_DEF FOREIGN KEY (DASHID) REFERENCES DMS_DASH_DEF(DASHID)
);
CREATE INDEX IDX_DMS_DASH_EXPORT_DASH ON DMS_DASH_EXPORT_LOG(DASHID, EXPRT_AT);

CREATE SEQUENCE DMS_SUPPORTED_DATABASES_SEQ START WITH 1 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER DMS_SUPPORTED_DATABASES_TRG
BEFORE INSERT ON DMS_SUPPORTED_DATABASES
FOR EACH ROW
BEGIN
    IF :NEW.DBID IS NULL THEN
        SELECT DMS_SUPPORTED_DATABASES_SEQ.NEXTVAL INTO :NEW.DBID FROM DUAL;
    END IF;
END;
/

CREATE SEQUENCE DMS_MAPRSQLSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_MAPRSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_MAPRDTLSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_MAPERRSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBDTLSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBFLWSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBSCHSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_PRCLOGSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBLOGSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_JOBERRSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_FLUPLDSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_FLUPLDDTLSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_FLUPLDACCLGSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_FLUPLDVLDSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_FLUPLDSECSEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE DMS_DASH_DEF_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE DMS_DASH_WIDGET_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE DMS_DASH_FILTER_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE DMS_DASH_SHARE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE DMS_DASH_EXPORT_LOG_SEQ START WITH 1 INCREMENT BY 1;

INSERT INTO DMS_SUPPORTED_DATABASES (DBTYP, DBDESC, DBVRSN, STATUS, CRTDBY)
SELECT 'GENERIC', 'Generic/Universal Datatypes (Reference)', NULL, 'ACTIVE', 'SYSTEM'
FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM DMS_SUPPORTED_DATABASES WHERE DBTYP = 'GENERIC');

UPDATE DMS_PARAMS
SET DBTYP = 'GENERIC'
WHERE PRTYP = 'Datatype' AND DBTYP IS NULL;

COMMIT;

-- ============================================================================
-- Test Data Load Placeholder
-- Paste INSERT statements for your test data below and execute.
-- ============================================================================
-- INSERT INTO DMS_PARAMS (...);
-- INSERT INTO DMS_MAPR (...);
-- COMMIT;
